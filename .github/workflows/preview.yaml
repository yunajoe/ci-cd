name: Build, Test, and Merge to Main Branch

on:
  push:
    branches:
      - develop # develop ë¸Œëœì¹˜ì—ì„œ push ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì‹¤í–‰

run-name: ${{ github.actor }} is Build, Test, Merge Processing ğŸš€

jobs:
  build:
    runs-on: ubuntu-latest # 'ubuntu-lastest' -> 'ubuntu-latest'ë¡œ ìˆ˜ì •
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "16"

      - name: Install dependencies
        run: npm install

      - name: Run Build
        run: |
          echo "ë¹Œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
          npm run build  # ë¹Œë“œ ëª…ë ¹ ì‹¤í–‰
          if [ $? -ne 0 ]; then
            echo "ë¹Œë“œê°€ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤"
            exit 1  # ë¹Œë“œ ì‹¤íŒ¨ ì‹œ ì›Œí¬í”Œë¡œìš° ì¢…ë£Œ 
          fi

  test:
    runs-on: ubuntu-latest
    needs: build # build ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œëœ í›„ì— ì‹¤í–‰ë¨
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "16"

      - name: Install dependencies
        run: npm install

      - name: Run Tests
        run: |
          echo "í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
          npm test  # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          if [ $? -ne 0 ]; then
            echo "í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤"
            exit 1  # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ ì›Œí¬í”Œë¡œìš° ì¢…ë£Œ
          fi

  merge:
    runs-on: ubuntu-latest
    needs: test # test ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œëœ í›„ì— ì‹¤í–‰ë¨
    if: success() # ë¹Œë“œì™€ í…ŒìŠ¤íŠ¸ê°€ ëª¨ë‘ ì„±ê³µí•˜ë©´ ì‹¤í–‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "github-actions@github.com"

      - name: Check for merge conflicts
        run: |
          git fetch origin
          git checkout main
          git merge origin/develop || echo "Merge conflict detected. Please resolve manually."

      - name: Merge changes to main
        run: |
          git pull origin main
          git merge develop --allow-unrelated-histories -m "Automated merge from develop to main"
          git push origin main
